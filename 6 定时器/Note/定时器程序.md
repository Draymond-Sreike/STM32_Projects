# 定时器程序

> ![image-20230203003929678](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203003929678.png)

编写定时器的程序就是把上图所示的各个模块给打通。步骤如下：

1. **RCC开启时钟**。这是每个代码的第一步，无需多虑；在这里打开时钟后定时器的基准时钟和整个外设的工作时钟都会同时被打开。
2. **选择时基单元的时钟源，即时钟模式**。对于定时中断，我们就选择“内部时钟模式”。
3. **配置时基单元**。包括了PSC、ARR、CNT，这些寄存器的配置通过一个结构体配置即可。
4. **配置中断输出控制**。允许更新中断输出到NVIC。
5. **配置NVIC**。在NVIC中打开定时器中断的通道，并分配一个优先级。
6. **配置运行控制**。整个定时器模块在上述步骤配置完成后，我们还需要使能一下计数器，要不然计数器是不会运行的。
    - 当定时器使能后，计数器就会开始计时了
    - 当计数器更新时，就会触发中断
7. **编写定时中断函数**。每隔一段时间该中断函数就会自动执行一次。

## 定时器相关函数

1. > ![image-20230203004641874](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203004641874.png)

    恢复缺省配置。

### 时基单元配置

1. > ![image-20230203004702551](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203004702551.png)

    配置时基单元，完成时基单元初始化。

### 运行控制

1. > ![image-20230203004808652](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203004808652.png)

    使能计数器，即运行控制。

### 中断输出控制

1. > ![image-20230203004938592](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203004938592.png)

    使能中断输出信号，即中断输出控制。

    - TIM_IT：选择配置哪个中断输出

### 时钟源选择

> <img src="D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203005048212.png" alt="image-20230203005048212" style="zoom:80%;" />
>
> **这6个函数用来配置时基单元的时钟选择部分，即时钟源选择  **：
>
> ​	<img src="D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203005122044.png" alt="image-20230203005122044" style="zoom:50%;" />

1. > ![image-20230203005601197](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203005601197.png)

    选择内部时钟。调用之后就打通了下面一路：

    > ·<img src="D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203005550726.png" alt="image-20230203005550726" style="zoom:50%;" />

2. > ![image-20230203005742661](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203005742661.png)

    选择ITRx其他定时器的时钟。

    - TIM_InputTriggerSource：选择要接入哪个其他定时器。

    该函数调用后，连接通路如下图所示：

    > <img src="D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203005902758.png" alt="image-20230203005902758" style="zoom:50%;" />

3. > ![image-20230203005917476](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203005917476.png)

    选择ITx捕获通道的时钟。

    - TIM_TIxExternalCLKSource：选择TIx具体的某个引脚
    - TIM_ICPolarity，ICFilter：输入的极性和滤波器。对于外部输入的信号一般都会有极性和滤波器。

    调用之后函数的通路如下图所示：

    > <img src="D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203010211067.png" alt="image-20230203010211067" style="zoom:50%;" />

4. > ![image-20230203010237274](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203010237274.png)
    >
    > ![image-20230203010525892](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203010525892.png)
    >
    > 

    选择ETR通过外部时钟模式1输入的时钟。通路示意图如下：

    > <img src="D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203010401864.png" alt="image-20230203010401864" style="zoom: 50%;" />

    - ExtTRGPrescaler：外部触发预分频器，这里可以对ETR外部输入的时钟再提前做一个分频 

    - ExtTRGPolarity、ExtTRGFilter：极性和滤波器

5. > ![image-20230203010722952](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203010722952.png)

    选择ETR通过外部时钟模式2输入的时钟。对于ETR输入的外部时钟而言，这个函数与上一个外部时钟模式1所对应的函数功能是等效的（在不需要触发输入功能的前提下）。通路示意图如下：

    > <img src="D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203010756700.png" alt="image-20230203010756700" style="zoom:50%;" />

6. > ![image-20230203010958349](D:\大学\单片机学习\MCU Learning Resource\STM32\STM32_Projects\6 定时器\Note\image-20230203010958349.png)

    不用于选择时钟，单独用于配置ETR引脚的预分频器、极性、滤波器等参数。



